<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<link rel="stylesheet" href="/resources/css/compare.css">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/izimodal/1.6.1/css/iziModal.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>

<div class="bg-white">
	<div class="cen">
	
		<div class="ent-area">
			
			<div class="ent-item active" id="ent-item1">
				<div class="ent-link">
					<div class="active-logo">
						<img alt="" src="/resources/images/ent-logo.jpg">
					</div> 
				</div>
<!-- 				<div><i class="fa-solid fa-plus" style="color:#00c362"></i></div> -->
<!-- 				<p class="p-17">비교기업 추가</p> -->
			</div>
			
			<div class="ent-item" id="ent-item2">
				<div><i class="fa-solid fa-plus" style="color:#00c362"></i></div>
				<p class="p-17">비교기업 추가</p>
			</div>
			
			<div class="ent-item" id="ent-item3">
				<div><i class="fa-solid fa-plus" style="color:#00c362"></i></div>
				<p class="p-17">비교기업 추가</p>
			</div>
			
		</div>
		
		<div class="accordion mt-40 mb-40">
			<div class="accordion-tab">
				<p class="compare-tit">평점</p>
				<span class="expand-icon"></span>
			</div>
			
			<div class="accordion-cont rate">
				
				<p class="compare-tit">총 만족도</p>
				
				<div class="disabled-col">
					<p class="p-15 mb-5"><span class="bold">전체</span> 통계</p>
					
					<div class="avg-rate">
						<img alt="" src="/resources/images/star.svg">
						<p>
							<fmt:formatNumber value="0.0" pattern="0.0"/>
						</p>
					</div>
					
					<canvas class="avg-rate-chart"></canvas>
					
					
					<div class="rates">
					
						<div class="welfare">
							<p>복지 및 급여</p>
							<p>
								<i class="fa-solid fa-star" style="color: #fbba2d;"></i>
								<span class="bold">4.2</span>
							</p>
						</div>
						<div class="welfare">
							<p>워라밸</p>
							<p>
								<i class="fa-solid fa-star" style="color: #fbba2d;"></i>
								<span class="bold">4.2</span>
							</p>
						</div>
						<div class="welfare">
							<p>사내문화</p>
							<p>
								<i class="fa-solid fa-star" style="color: #fbba2d;"></i>
								<span class="bold">4.2</span>
							</p>
						</div>
						<div class="welfare">
							<p>승진 기회</p>
							<p>
								<i class="fa-solid fa-star" style="color: #fbba2d;"></i>
								<span class="bold">4.2</span>
							</p>
						</div>
						<div class="welfare">
							<p>경영진</p>
							<p>
								<i class="fa-solid fa-star" style="color: #fbba2d;"></i>
								<span class="bold">4.2</span>
							</p>
						</div>
					
					</div>
					
				</div>
				
			</div>
			
		</div>
		
		<div>
		  <canvas id="mixed-chart"></canvas>
		</div>
	</div> 
</div>
<!-- Modal structure -->
<div id="modal-compare">
    <section>
    	<button data-izimodal-close="" class="icon-close"><i class="fa-solid fa-xmark"></i></button>
	  	<div class="focus-green mb-45 auto-complete-area">
			<div class="focus-green mb-45 auto-complete-area">
				<p class="p-20 bold mb-20">비교하고 싶은 기업을 입력해 주세요</p>
				<input class="input01 mb-0 w-100" id="ent-srch" placeholder="비교하고 싶은 기업을 선택해 주세요">
				<div id="ent-srch-list">
	
				</div>
		  	</div>
		</div>
    	<input type="hidden" id="entNo" />
    	
    	<div class="selected-ent">
    		<p class="p-12 bold mb-9">선택된 기업(<span class="selected">0</span>/3)</p>
    			<p class="empty-selected">기업을 선택해 주세요.</p>
    		<div class="selected-ent-list">
    		</div>
    	</div>
    	
         <div class="mt-20 talign-center">
             <button class="btn btn-sm modalCancel" data-izimodal-close="" data-izimodal-transitionout="comingOut">취소</button>
             <button class="btn btn-sm bg-red color-white modalSubmit" data-izimodal-close="" data-izimodal-transitionout="bounceOutDown">확인</button>
         </div>
	</section>
</div>















<script src="https://cdnjs.cloudflare.com/ajax/libs/izimodal/1.6.1/js/iziModal.min.js"></script>
<script>
	

	let selectedItems = document.querySelectorAll(".selected-ent-list .selected-ent-item");
	
	let modalCompare = document.querySelector("#modal-compare");
	
	let datas = [];
	
	function chkSelectedLength(){

		let selectedList = document.querySelector(".selected-ent-list");

		let selected = document.querySelector(".selected");
		
		selected.innerHTML = selectedList.children.length;
		
	}
	
	function delThis(e){
		console.log(e.parentElement);
		let entNo = e.parentElement.children.entNo.value;
		datas.forEach((item, index)=>{
			if(item.entNo === entNo){
				datas.splice(index, 1);
			}
		})
		e.parentElement.remove();
		chkSelectedLength();
		isEmpty();
		console.log(datas);
	}

	function isEmpty(){
		let selectedItem = document.querySelectorAll(".selected-ent-list .selected-ent-item");
		let emptySelected = document.querySelector(".empty-selected");
		console.dir(selectedItem.length);
		if(selectedItem.length >= 1){
			emptySelected.style.display = "none";
		}else{
			emptySelected.style.display = "flex";			
		}
		
	}
	isEmpty();
	const avgChart = document.querySelector('.avg-rate-chart');
	
	console.log(avgChart)
	
	let today = new Date();   
	let year = today.getFullYear();
	
	new Chart(avgChart, {
	    type: 'line',
	    data: {
	      labels: [year-3, year-2, year-1, year],
	      datasets: [{
	          label: "",
	          borderColor: "#00c362",
	          data: [3.8, 2.5, 4.0, 2.7],
	          fill: true,
              pointRadius: 3, // 포인트 크기
              pointBackgroundColor: "#00c362"
	        }
	      ]
	    },
	    options: {
		  plugins:{
		       legend: {
		           display: false
		       }
		  },
	      title: {
	        display: false,
	      },
          scales: {
              y: {
                  min : 1.0,  
                  max : 5.0  
              },
          }
	    }
	});
	

	$("#modal-compare").iziModal({
	    title: '',
	    subtitle: '',
	    headerColor: '#88A0B9',
	    background: null,
	    theme: '',  // light
	    icon: null,
	    iconText: null,
	    iconColor: '',
	    rtl: false,
	    width: 500,
	    top: null,
	    bottom: null,
	    borderBottom: true,
	    padding: 0,
	    radius: 3,
	    zindex: 999,
	    iframe: false,
	    iframeHeight: 400,
	    iframeURL: null,
	    focusInput: true,
	    group: '',
	    loop: false,
	    arrowKeys: true,
	    navigateCaption: true,
	    navigateArrows: true, // Boolean, 'closeToModal', 'closeScreenEdge'
	    history: false,
	    restoreDefaultContent: false,
	    autoOpen: 0, // Boolean, Number
	    bodyOverflow: false,
	    fullscreen: false,
	    openFullscreen: false,
	    closeOnEscape: true,
	    closeButton: true,
	    appendTo: 'body', // or false
	    appendToOverlay: 'body', // or false
	    overlay: true,
	    overlayClose: false,
	    overlayColor: 'rgba(0, 0, 0, 0.4)',
	    timeout: false,
	    timeoutProgressbar: false,
	    pauseOnHover: false,
	    timeoutProgressbarColor: 'rgba(255,255,255,0.5)',
	    transitionIn: 'comingIn',
	    transitionOut: 'comingOut',
	    transitionInOverlay: 'fadeIn',
	    transitionOutOverlay: 'fadeOut',
	    onFullscreen: function(){},
	    onResize: function(){},
	    onOpening: function(){},
	    onOpened: function(){},
	    onClosing: function(){},
	    onClosed: function(){},
	    afterRender: function(){}
	});
	
	let entItems = document.querySelectorAll(".ent-item");
	
	for(let i = 0; i < entItems.length; i++ ){
		console.log(entItems[i]);
		entItems[i].addEventListener("click", function(){		
			console.log("123");
			$("#modal-compare").iziModal('open');			
		})
	}
	
	
	function debounce(callback, limit = 100) {
	    let timeout;
	    return function(...args) {
		        clearTimeout(timeout)
		        timeout = setTimeout(() => {
		            callback.apply(this, args)
		        }, limit)
	    }
	}
	
	
	let entSrch = document.querySelector("#ent-srch");
	console.log(entSrch);
	let entSrchList = document.querySelector("#ent-srch-list");
	console.log(entSrchList);
	
	function inpVal(e){
	
		console.dir(e.children.entNo.value);
		
		entSrch.value = "";
		
		let entNo = document.querySelector("#entNo");
		console.dir(e.children.entNo.value);
		console.dir(entNo);
		entNo.value = e.children.entNo.value;
		
// 		entSrchList.innerHTML = "";
		entSrchList.style.display = "none";
		
		let data = {
 				"entNo" : entNo.value
		}
		
		
		$.ajax({
			url : "/enterprise/ajaxGetEntOne",
			contentType : "application/json; charset=UTF-8",
			data : JSON.stringify(data),
			dataType : "json",
			type : "post",
			beforeSend : function(xhr) {
				xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
			},
			success : function(res) {

				console.log(datas.length)
				
				if(datas.length >= 3){
					alert("기업 비교는 최대 3개까지 선택 가능합니다.");
					return;
				}
				
				console.log("res",res);
				let str = "";
				
				str+='<div class="selected-ent-item">';
                str+='<input name="entNo" type="hidden" value="'+res.entNo+'">    ';
                str+='<input class="chkbox-sig" onclick="delThis(this)" type="checkbox" checked name="" id="keep-logged">    ';
                str+='<label for="keep-logged"></label>                                      ';
                str+='<div class="checked-item">                                '    ;
                str+='	<div class="ent-logo">                                  '    ;
                if(res.entLogo == null || res.entLogo == ''){
	                str+='		<img alt="" src="/resources/images/ent-logo.png">   '    ;
                }else{
	                str+='		<img alt="" src="/resources/upload/'+res.entLogo+'">   '    ;                	
                }
                str+='	</div>                                                  '    ;
                str+='	<div>                                                   '    ;
                str+='		<p class="p-16 bold mb-7">'+res.entNm+'</p>        '    ;
                str+='		<p class="txt-gray p-12">                           '    ;
                str+='			<span>'+res.entSector+'</span>                          '    ;
                str+='			<span class="v-div-liune"></span>               '    ;
                str+='			<span>'+res.entCeonm+'</span>                             '    ;
                str+='		</p>                                                '    ;
                str+='	</div>                                                  '    ;
                str+='</div>                                                    '    ;


				let selectedList = document.querySelector(".selected-ent-list");
				console.log("222",selectedList);
				

                selectedList.insertAdjacentHTML("beforeend", str);
				console.log(selectedList);

				chkSelectedLength();
				
				isEmpty();
				
				datas.push(res);
				
				console.log("datas",datas);
               	
			}
			
		})
		
		
	}
	
	entSrch.addEventListener("keyup", debounce(function(){
				
		let data = {
 				"entNm" : entSrch.value
		}
		
		console.log(data);

		$.ajax({
			url : "/boardEntReview/ajaxGetEnt",
			contentType : "application/json; charset=UTF-8",
			data : JSON.stringify(data),
			dataType : "json",
			type : "post",
			beforeSend : function(xhr) {
				xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
			},
			success : function(res) {
				let list = document.querySelector("#ent-srch-list");
				console.log(list);
				
				if(entSrch.value == "" || entSrch.value == null){
					list.style.display = "none";
				}else{
					list.style.display = "block";					
					console.log(res);
					
					if(res.length == 0){
						list.innerHTML = `<span class="bold p-25">해당 검색 결과가 없습니다</span>`; 
						return;
					}
					
					let str = "";
					
					for(let i = 0 ; i < res.length; i++){
						
						let dis = true;
						
						let entNo = res[i].entNo;
						
						str += '<div class="ent-srch-list-item';
						datas.forEach((item, index)=>{
							if(item.entNo === entNo){
								str += ' disabled"> ';
								dis = false;
							}
						})
						if(dis){							
							str +='" onclick="inpVal(this)">';
						}
						str += '<input type="hidden" value="'+res[i].entNo+'">';
		                if(res[i].entLogo == null || res[i].entLogo == ''){
			                str+='		<img alt="" src="/resources/images/ent-logo.png">   '    ;
		                }else{
			                str+='		<img alt="" src="/resources/upload/'+res[i].entLogo+'">   '    ;                	
		                }
						str += '	<div>';
						str += '		<p class="ent-srch-list-ent-name">'+res[i].entNm+'</p>';
						str += '		<p class="ent-srch-list-ent-cont">';
						str += '			<span class="ent-sector">'+res[i].entSector+'</span>';
						str += '			<span class="ent-ceoNm">'+res[i].entCeonm+'</span>';
						str += '		</p>';
						str += '	</div>';
						str += '	<input type="hidden" name="entNo" value="'+res[i].entNo+'" />';
						str += '</div>';
					};
					
					list.innerHTML = str;
					
					
					isEmpty();
					
				}
				
			}
		})
	}, 500))
	
	
	
	// 체크박스 관련 js
	let chkboxSig = document.querySelector(".chkbox-sig");
	let chkboxTxt = document.querySelector(".chkbox-txt");

	$(document).on("change", chkboxSig, function (e) {
	    console.dir(e.target.checked);
	})
	
    
	let modalCancel = document.querySelector(".modalCancel");
	
	modalCancel.addEventListener("click", function(){

		 resetModal()
		 datas = [];
		
	})
	
	let modalSubmit = document.querySelector(".modalSubmit");
	
	modalSubmit.addEventListener("click", function(){
		
		resetModal();
		console.log(datas);
		
		drawModal();
		
		for(let i = 0 ; i < datas.length; i++){
			
			let str = '';
			
			
		}
		
		
	})
	
	let btnClose = document.querySelector(".icon-close");
	
	btnClose.addEventListener("click", function(){

		resetModal();

		datas = [];	
		
		
		
		
		 
	})
	
	function resetModal(){

		let list = document.querySelector(".selected-ent-list");
		
		let emptySelected = document.querySelector(".empty-selected");
		
		list.innerHTML = "";
		
		console.log("list", list)
		
		emptySelected.style.display = "flex";
		
		chkSelectedLength();
		
		entSrchList.innerHTML = '';
		entSrchList.style.display = "none";
		
		
	}
	
	function drawModal(){

		for(let i = 0; i < datas.length; i++){
			let str = "";
			
			str+='<div class="selected-ent-item">';
	        str+='<input name="entNo" type="hidden" value="'+datas[i].entNo+'">    ';
	        str+='<input class="chkbox-sig" onclick="delThis(this)" type="checkbox" checked name="" id="keep-logged">    ';
	        str+='<label for="keep-logged"></label>                                      ';
	        str+='<div class="checked-item">                                '    ;
	        str+='	<div class="ent-logo">                                  '    ;
	        if(datas[i].entLogo == null || datas[i].entLogo == ''){
	            str+='		<img alt="" src="/resources/images/ent-logo.png">   '    ;
	        }else{
	            str+='		<img alt="" src="/resources/upload/'+datas[i].entLogo+'">   '    ;                	
	        }
	        str+='	</div>                                                  '    ;
	        str+='	<div>                                                   '    ;
	        str+='		<p class="p-16 bold mb-7">'+datas[i].entNm+'</p>        '    ;
	        str+='		<p class="txt-gray p-12">                           '    ;
	        str+='			<span>'+datas[i].entSector+'</span>                          '    ;
	        str+='			<span class="v-div-liune"></span>               '    ;
	        str+='			<span>'+datas[i].entCeonm+'</span>                             '    ;
	        str+='		</p>                                                '    ;
	        str+='	</div>                                                  '    ;
	        str+='</div>  ';             
	        
			let selectedList = document.querySelector(".selected-ent-list");
			console.log("222",selectedList);
			
	
	        selectedList.insertAdjacentHTML("beforeend", str);
			console.log(selectedList);
	
			chkSelectedLength();
			
			console.log("datas",datas);	
			
			isEmpty();
		}
		


		
	}
	
</script>
