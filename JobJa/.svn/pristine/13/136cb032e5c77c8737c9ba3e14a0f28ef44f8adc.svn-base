<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/izimodal/1.6.1/css/iziModal.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/izimodal/1.6.1/js/iziModal.min.js"></script>
<style>
.mypage-body-con{
	background-color: #fff;
	border-radius: 30px;
 	padding: 24px; 
 	height: 800px;
}
.body-sub-title{
	font-size: 24px;
	font-weight: bold;
	margin-bottom: 8px;
}

.title-hr{
	border: 1px solid #ccc;
	margin-bottom: 8px;
	width: 100%;
}

.rcmd-list{
	grid-template-rows: none !important;
}
.con-review-title{
	margin-top: 16px;
}
.modal-custom{
	padding: 40px 0 40px 40px;
	max-width: 640px !important;
    height: 720px!important;

}
.modal-review{
	padding: 40px 0 40px 40px;
	max-width: 640px !important;
    height: 800px!important;

}
.review-title{
	margin-bottom: 24px;
}
.btn-parent{
	display: flex;
    justify-content: flex-end;
}
.review-cont{
	width: 560px;
	margin-bottom: 32px;
}
.icon-close:before{ 
 	content: "\f00d"; 
     display: inline-block; 
     font-family: "Font Awesome 5 Free"; 
     font-weight: 900; 
     color: #666; 
} 
.modal-custom .icon-close {
    background: #FFF;
    margin-bottom: 10px;
    position: absolute;
    right: -15px;
    top: -50px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    border: 0;
    color: #a9a9a9;
    cursor: pointer;
}
.modal-review section{
	height: 720px;
    overflow-y: auto;
}

.modal-review .icon-close {
    background: #FFF;
    margin-bottom: 10px;
    position: absolute;
    right: -15px;
    top: -50px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    border: 0;
    color: #a9a9a9;
    cursor: pointer;
}
.modal-custom section{
	height: 720px;
    overflow-y: auto;
}
	
.con-review{
	font-size: 16px !important;
	font-weight: 500;
	cursor: pointer;
	margin-left: 16px;
	color: #2bca34;
}
.con-review:hover{
	font-weight: 700 !important;
}
.detail-one-line{
	align-items: center;
}

.consult-textarea{
    border: 1px solid #ccc;
    border-radius: 10px;
    width: 100%;
    min-height: 360px;
    border-radius: 15px 15px;
    padding: 8px;
    resize: none;
    
}
.consult-textarea:focus{
	outline: none;
}
.btn-parents{
	display: flex;
	justify-content: flex-end;
	margin-right: 39px;
}
</style>
<div class="mypage-body-con">
	<div class="sub-title-area">
		<div class="body-sub-title">
			나의 상담기록
		</div>
		<hr class="title-hr"/>
	</div>
		
	<div class="body-sub-con">
		<c:forEach var="conVOList" items="${consultantLogVOList}" varStatus="stat">
			<p class="bold p-24 con-review-title">${conVOList.conNm} 상담사와의 기록  
				<span class="con-review p-13 ml-auto">리뷰작성</span>
				<input type="hidden" value="${conVOList.payNo}"></p>
				<input type="hidden" value="${conVOList.itemNo}"></p>
			<div class="rcmd-list">
				<c:forEach var="conVO" items="${conVOList.consultantLogVO}" varStatus="stat">
					<div class="rcmd-item">
						<div class="rcmd-item-img">
									<img alt="프로필" src="/resources/upload/${conVOList.memAfId}">								
						</div>
						<div class="rcmd-item-info">
							<div class="rcmd-item-top">
								<p class="bold p-16">${conVO.cnsltntTitle}</p>
								<span class="txt-skyblue p-13 ml-auto preview con-log-btn">상담기록보기</span>
								<input type="hidden" name="cnsltntNo" value="${conVO.cnsltntNo}">
								<input type="hidden" name="memId" value="${conVOList.memId}">
								<input type="hidden" name="conMemId" value="${conVO.conMemId}">
								<input type="hidden" name="payNo" value="${conVO.payNo}">
							</div>
							<div>
								<p class="bold p-14 mb-7">
									<span class="workPeriod">${conVO.cnsltntTimes}회차상담 </span>
								</p>
								<p class="txt-gray p-12 mb-3">
									상담날짜 : <fmt:formatDate value="${conVO.cnsltntDt}" pattern="yyyy-MM-dd"/>
								</p>
							</div>
						</div>
					</div><!-- end rcmd-item -->
					
				</c:forEach>
				
			</div><!-- end rcmd-list -->
			
		</c:forEach>
				
	</div><!-- end body-sub-con -->
	
	
	
	<div class="modal-custom">
		<section>
        	<button data-izimodal-close="" class="icon-close"></button>
        	<p class="modal-title bold p-24 review-title">상담 기록</p>
        	<div class="modal-con modal-log-con">
        	
        	
        	</div><!-- end modal-con -->
      	</section>
	</div>
	
	
	<div class="modal-review">
		<section>
        	<button data-izimodal-close="" class="icon-close"></button>
        	<p class="modal-title bold p-24 review-title">리뷰남기기</p>
        	<div class="modal-con modal-review-con">
        		<div class="review-info-con">
	          		
				</div>
          		<div class="mb-12 p-15 detail-one-line">
					<p class="bold">평점</p>
					<div class="cnsltntDt rate-area">
			                <span class="star">
			                   	 ★★★★★
			                    <span style="width: 20%;">★★★★★</span>
			                    <input type="range" id="entRevBalance" name="reviewRate" oninput="drawStar(this)" value="1" step="1" min="1" max="5">
			                </span>
					</div>
				</div>
				
				<div class="h-div-line" style="width:95%; margin:35px 0;"></div>
				
				<div class="review-cont">
					<textarea class="consult-textarea" name="reviewCntnt"></textarea>
				</div>
				
				<div class="btn-parents">
					<button type="button" class=" btn-sm btn-write btn review-con-submit">작성완료</button>
				</div>
				
	          </div><!-- end modal-con -->
	      </section>
	</div>
	
</div>

<script type="text/javascript">

//JAVASCRIPT CODE
const drawStar = (target) => {
	console.log(target.value)
	console.dir(target.previousElementSibling);
	target.previousElementSibling.style.width = target.value * 20 + "%";
}
document.querySelector(".star input").addEventListener("change", function(e){
    console.dir(e.target.value);
})

$(document).ready(function(){
	$('.preview').off("click").on("click", function(e){
    	let cnsltntNo = e.target.nextElementSibling.defaultValue;
    	
    	let data = {"cnsltntNo" : cnsltntNo};
    	
    	$.ajax({
    		url: "/member/ajaxgetOneReview",
    		contentType: "application/json;charset=utf-8",
        	dataType: 'json',
			type: 'post',
			data : JSON.stringify(data),
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
			success:function(rst){
				
				let cont = `
				
		          		<div class="mb-12 p-15 detail-one-line">
							<p class="bold">이름</p>	 
							<p class="memNm">\${rst.memNm}</p>
						</div>
		          		<div class="mb-12 p-15 detail-one-line">
							<p class="bold">제목</p>	 
							<p class="cnsltntTitle">\${rst.cnsltntTitle}</p>
						</div>
		          		<div class="mb-12 p-15 detail-one-line">
							<p class="bold">상담회차</p>	 
							<p class="cnsltntTimes">\${rst.cnsltntTimes}회차</p>
						</div>
		          		<div class="mb-12 p-15 detail-one-line">
							<p class="bold">상담일시</p>	 
							<p class="cnsltntDt">\${rst.cnsltntDt}</p>
						</div>
						
						<div class="h-div-line" style="width:95%; margin:35px 0;"></div>
						
						<div class="review-cont">
							<div>\${rst.cnsltntCntnt}</div>
						</div>
				
				`;
				
				$('.modal-log-con').html(cont);
				
			},
			error:function(xnr,status,error){
				console.log('Error:', xhr, status, error);
			}
    		
    		
    	});//end preview ajax
    	
    	
    	$('.modal-custom').iziModal('open');
    	
    	
    });//end preview click
    
    //리뷰 작성 클릭시
    $('.con-review').off("click").on("click", function(e){
    	
    	
    	console.dir(e.target.nextElementSibling);
    	
    	let payNo = e.target.nextElementSibling.defaultValue;
    	
    	let data ={"payNo" : payNo};
    	
    	
    	$.ajax({
    		url:"/member/ajaxgetReviewInfo",
    		contentType: 'application/json;charset-utf-8',
			dataType: 'json',
			type: 'post',
			data: JSON.stringify(data),
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
			success:function(rst){
				
				let cont = `
				
						<div class="mb-12 p-15 detail-one-line">
							<p class="bold">이름</p>	 
							<p class="memNm">\${rst.memNm}</p>
							<input type="hidden" name="itemNo" value="\${rst.itemCompanyNo}">
							<input type="hidden" name="reviewCnsltntId" value="\${rst.payConId}">
							<input type="hidden" name="reviewMemId" value="\${rst.payUserId}">
						</div>
		          		<div class="mb-12 p-15 detail-one-line">
							<p class="bold">상담사 이름</p>	 
							<p class="cnsltntTitle">\${rst.conNm}</p>
						</div>
		          		<div class="mb-12 p-15 detail-one-line">
							<p class="bold">상담 일시</p>	 
							<p class="cnsltntDt">\${rst.payStdt} ~ \${rst.payEddt}</p>
						</div>
				`;
				
				$('.review-info-con').html(cont);
				
				
			},
			error:function(xnr,status,error){
				console.log('Error:', xhr, status, error);
			}
    	});
    	
    	$('.modal-review').iziModal('open');
    	
    	$('.review-con-submit').off("click").on("click", function(){
    			
			if (confirm('리뷰를 작성 하시겠습니까?\n한번 작성된 리뷰는 수정,삭제 할 수 없습니다.')) {
				
    			let itemNo  = document.querySelector('input[name="itemNo"]').value;
    			let reviewMemId = document.querySelector('input[name="reviewMemId"]').value;
    			let reviewCnsltntId = document.querySelector('input[name="reviewCnsltntId"]').value;
    			let reviewRate = document.querySelector('input[name="reviewRate"]').value;
    			let reviewCntnt = document.querySelector('textarea[name="reviewCntnt"]').value;
    			
    			
    			console.log("itemNo : " + itemNo);
    			console.log("reviewMemId : " + reviewMemId);
    			console.log("reviewCnsltntId : " + reviewCnsltntId);
    			console.log("reviewRate : " + reviewRate);
    			console.log("reviewCntnt : " + reviewCntnt);
    			
    			let data = {
    					"itemNo" : itemNo,
    					"reviewMemId" : reviewMemId,
    					"reviewCnsltntId" : reviewCnsltntId,
    					"reviewRate" : reviewRate,
    					"reviewCntnt" : reviewCntnt
    			}
    			console.log(data);
    			
    			$.ajax({
    	    		url:"/member/ajaxinsertReview",
    	    		contentType: 'application/json;charset-utf-8',
    				dataType: 'json',
    				type: 'post',
    				data: JSON.stringify(data),
    				beforeSend:function(xhr){
    					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
    				},
    				success:function(rst){
    					if(rst == 1){
    						
    						alert("작성하신 리뷰가 등록 되었습니다.");
    						
    						$("textarea[name='reviewCntnt']").val("");
    						$(".star").children("span").eq(0).css("width","20%");
    						
    						$('.modal-review').iziModal('close');
    					}else{
    						alert("등록실패");
    					}
    					
    					
    					
    				},
    				error:function(xnr,status,error){
    					console.log('Error:', xhr, status, error);
    				}
    	    	});
    			
    			
    			
    		
    		
			
			
    		
    		
	    	} else { 
	    		
	    		alert("작성 취소 되었습니다.");
	    		$('.modal-review').iziModal('close');
	    		
	    		
	    		
	    	}
			
			
			
		});//end review con submit
    	
    	
    });//end conreview
    
   
	
	
	
	
	$(".modal-custom").iziModal({
        title: '',
        subtitle: '',
        headerColor: '#88A0B9',
        background: null,
        theme: '',  // light
        icon: null,
        iconText: null,
        iconColor: '',
        rtl: false,
        width: 400,
        top: null,
        bottom: null,
        borderBottom: true,
        padding: 0,
        radius: 3,
        zindex: 999,
        iframe: false,
        iframeHeight: 400,
        iframeURL: null,
        focusInput: true,
        group: '',
        loop: false,
        arrowKeys: true,
        navigateCaption: true,
        navigateArrows: true, // Boolean, 'closeToModal', 'closeScreenEdge'
        history: false,
        restoreDefaultContent: false,
        autoOpen: 0, // Boolean, Number
        bodyOverflow: false,
        fullscreen: false,
        openFullscreen: false,
        closeOnEscape: true,
        closeButton: true,
        appendTo: 'body', // or false
        appendToOverlay: 'body', // or false
        overlay: true,
        overlayClose: true,
        overlayColor: 'rgba(0, 0, 0, 0.4)',
        timeout: false,
        timeoutProgressbar: false,
        pauseOnHover: false,
        timeoutProgressbarColor: 'rgba(255,255,255,0.5)',
        transitionIn: 'comingIn',
        transitionOut: 'comingOut',
        transitionInOverlay: 'fadeIn',
        transitionOutOverlay: 'fadeOut',
        onFullscreen: function(){},
        onResize: function(){},
        onOpening: function(){},
        onOpened: function(){},
        onClosing: function(){},
        onClosed: function(){},
        afterRender: function(){}
    });// end modal
    
    
	$(".modal-review").iziModal({
        title: '',
        subtitle: '',
        headerColor: '#88A0B9',
        background: null,
        theme: '',  // light
        icon: null,
        iconText: null,
        iconColor: '',
        rtl: false,
        width: 400,
        top: null,
        bottom: null,
        borderBottom: true,
        padding: 0,
        radius: 3,
        zindex: 999,
        iframe: false,
        iframeHeight: 400,
        iframeURL: null,
        focusInput: true,
        group: '',
        loop: false,
        arrowKeys: true,
        navigateCaption: true,
        navigateArrows: true, // Boolean, 'closeToModal', 'closeScreenEdge'
        history: false,
        restoreDefaultContent: false,
        autoOpen: 0, // Boolean, Number
        bodyOverflow: false,
        fullscreen: false,
        openFullscreen: false,
        closeOnEscape: true,
        closeButton: true,
        appendTo: 'body', // or false
        appendToOverlay: 'body', // or false
        overlay: true,
        overlayClose: true,
        overlayColor: 'rgba(0, 0, 0, 0.4)',
        timeout: false,
        timeoutProgressbar: false,
        pauseOnHover: false,
        timeoutProgressbarColor: 'rgba(255,255,255,0.5)',
        transitionIn: 'comingIn',
        transitionOut: 'comingOut',
        transitionInOverlay: 'fadeIn',
        transitionOutOverlay: 'fadeOut',
        onFullscreen: function(){},
        onResize: function(){},
        onOpening: function(){},
        onOpened: function(){},
        onClosing: function(){},
        onClosed: function(){},
        afterRender: function(){}
    });// end modal
    
});

</script>
