package jobja.mypage.controller;

import java.security.Principal;
import java.util.ArrayList;
import java.util.List;
import java.util.HashMap;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;

import jobja.atchfile.vo.AtchFileDetailVO;
import jobja.board.service.BoardEntReviewService;
import jobja.board.vo.BoardClassVO;
import jobja.board.vo.BoardEntReviewVO;
import jobja.common.mapper.ComCodeMapper;
import jobja.common.vo.ComCodeInfoVO;
import jobja.common.vo.ComDetCodeInfoVO;
import jobja.member.service.EnterpriseService;
import jobja.member.vo.EnterpriseVO;
import jobja.mypage.member.service.MemberService;
import jobja.mypage.member.vo.MemberVO;
import jobja.util.ModelAttributeUtil;
import jobja.recruit.service.RecruitService;
import jobja.sort.vo.JobOfferFilterVO;
import jobja.util.ArticlePage;


import lombok.extern.slf4j.Slf4j;
import lombok.extern.java.Log;

@RequestMapping("/enter")
@Slf4j
@Controller
public class EntMyPageController {
	
	@Autowired
	ModelAttributeUtil modelAttributeUtil;
	
	@Autowired
	EnterpriseService enterpriseService;
	
	@Autowired
	BoardEntReviewService boardEntReviewService;
	
	@Autowired
	ComCodeMapper comCodeMapper;
	
	@Autowired
	MemberService memberService;
	
	@Autowired
	RecruitService recruitService;
	
	
	// 기업 마이페이지 - 아무것도 없는 메인 - 바꿔도 됨!!!!
	@GetMapping("/mypage")
	public String entMypage() {
		
		return "mypageEnt/entMyPage";
	}
	
	/**
	 * 기업 파일함
	 * @param model
	 * @return
	 */
	@GetMapping("/filepage")
	public String filePage(Model model) {
		
		MemberVO memberVO = modelAttributeUtil.getCurrentLoginName();
		String memId = memberVO.getMemId();
		
		List<AtchFileDetailVO> atchDtVOList = this.memberService.atchDtList(memId);

		memberVO.setAtchfileDetailVO(atchDtVOList);
		
		log.info("list => atchDtVOList : " +atchDtVOList);
		log.info("list => memberVO : " +memberVO);
		
		model.addAttribute("memberVO",memberVO);
		
		return "mypageEnt/entSaveFile";
	}
	
	/**
	 * ajax 파일첨부함 파일 추가
	 * entNo으로 넘기고 싶었는데 실패..
	 * @param uploadFile
	 * @return
	 */
	@PostMapping("/entUploadFile")
	@ResponseBody
	public List<AtchFileDetailVO> uploadFile(@RequestParam("uploadFile") MultipartFile[] uploadFile) {
	    
	    log.info("uploadFile -> uploadFile : " + uploadFile);
	    
	    MemberVO memberVO = modelAttributeUtil.getCurrentLoginName();
	    memberVO.setUploadFile(uploadFile);
	    
	    log.info("uploadFile -> memberVO.getUploadFile() : " + memberVO.getUploadFile());
	    List<AtchFileDetailVO> atchFileDetailList = new ArrayList<>(); // 리스트 생성
	    
	    try {
	        for (MultipartFile file : uploadFile) {
	            if (!file.isEmpty()) {
	                
	                log.info("uploadFile => if문 안임");
	                
	                AtchFileDetailVO atchFileDetailVO = memberService.uploadFileKeyCheck(memberVO);
	                log.info("uploadFile => atchFileDetailVO 들어가면 이거 나옴 : " + atchFileDetailVO);
	                
	                String memId = memberVO.getMemId();
	                
	                // 단일 파일 정보를 가져오는 대신 리스트를 가져오도록 변경
	                List<AtchFileDetailVO> fileDetailList = this.memberService.atchFileDtVO(memId);
	                log.info("uploadFile => fileDetailList : " + fileDetailList);
	                
	                // 가져온 리스트를 전체 리스트에 추가
	                atchFileDetailList.addAll(fileDetailList);
	            }
	        }

	        return atchFileDetailList;
	        
	    } catch (Exception e) {
	        e.printStackTrace();
	        return atchFileDetailList; // 예외 발생 시 빈 리스트 반환
	    }
	}

    
	/**
	 * 파일 첨부함 파일 삭제
	 * @param atchFileDetailVO
	 * @return
	 */
    // AtchFileDetailVO(afdSeq=9, afId=a111, ...
    @PostMapping("/deleteFileAjax")
    @ResponseBody
    public String deleteFileAjax(@RequestBody AtchFileDetailVO atchFileDetailVO) {
    	
//    	MemberVO memberVO = modelAttributeUtil.getCurrentLoginName();
    	
    	log.info("deleteFileAjax -> atchFileDetailVO : " +atchFileDetailVO);
    	
    	try {
    		// 서비스를 통해 파일을 데이터베이스에서 삭제
    		int result = memberService.deleteFileAjax(atchFileDetailVO);
    		log.info("deleteFileAjax -> result : " + result);
    		
    		return "File deleted successfully!";
    	} catch (Exception e) {
    		e.printStackTrace();
    		return "File deletion failed";
    	}
    }
	
	// 채용공고 목록
	@GetMapping("/recruit")
	public String recruitList() {
		
		return "mypageEnt/entRecruitList";
	}
	
	// 채용공고 등록
	@GetMapping("/recruitCreate")
	public String recruitCreate() {
		
		return "mypageEnt/entRecruitCreate";
	}
	
	// 지원자 목록
	@GetMapping("/application")
	public String applicationList() {
		
		return "mypageEnt/entApplicationList";
	}

	// 일정관리
	@GetMapping("/calendar")
	public String calendar() {
		
		return "mypageEnt/entCalendar";
	}
	
	// 맞춤인재(입사제안)
	@GetMapping("/jobOffer")
	public String jobOffer(Model model,
			JobOfferFilterVO jobOfferFilterVO,
			@RequestParam(value = "currentPage",required = false, defaultValue = "1") int currentPage) throws JsonProcessingException {
		
		log.info("jobOfferFilterVO : " + jobOfferFilterVO);
		
		int size = 12;
		int pageSize = 5;
		
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("currentPage", currentPage);
		map.put("size", size);
		
		List<ComCodeInfoVO> comCodeInfoVOList = recruitService.getComCode();
		log.info("comCodeInfoVOList : "+ comCodeInfoVOList);
		
		List<ComDetCodeInfoVO> comCodeAb = this.recruitService.getComCodeInfoa();
		log.info("comCodeAb : "+ comCodeAb);
		

		log.info("livingLocation -> "+ jobOfferFilterVO.getLivingLocation());
		log.info("wishJobs ->"+ jobOfferFilterVO.getWishJobs());
		log.info("acdmCrs ->"+ jobOfferFilterVO.getAcdmCrs());
		
		log.info("comCodeInfoVOList -> "+ comCodeInfoVOList);
		
		if (jobOfferFilterVO.getWishJobs() != null) {
		    map.put("wishJobs", jobOfferFilterVO.getWishJobs());
		}
		if (jobOfferFilterVO.getLivingLocation() != null) {
		    map.put("livingLocation", jobOfferFilterVO.getLivingLocation());
		}

		log.info("map -> " + map);
		
		List<MemberVO> memberVOList = memberService.getRecommMemList(map);
		log.info("memberVOList", memberVOList);
		

		String wishJobsJson = new ObjectMapper().writeValueAsString(jobOfferFilterVO.getWishJobs());
		log.info("wishJobsJson : "+wishJobsJson);
		
		int total = memberService.getRecommMemCount(map);
		
		ArticlePage<MemberVO> data = new ArticlePage<MemberVO>(total, currentPage, size, pageSize, memberVOList);
		

		data.setUrl("/enter/jobOffer");
		data.setRecruitJobs(jobOfferFilterVO.getWishJobs() );
		data.setRecruitLocation(jobOfferFilterVO.getLivingLocation());
		
		model.addAttribute("livingLocation", jobOfferFilterVO.getLivingLocation());
		model.addAttribute("wishJobs", jobOfferFilterVO.getWishJobs());
		model.addAttribute("wishJobsJson", wishJobsJson);   
		model.addAttribute("comCodeInfoVOList", comCodeInfoVOList);
		model.addAttribute("comCodeAb", comCodeAb);
		model.addAttribute("memberVOList", memberVOList);
		model.addAttribute("data", data);
		
		return "mypageEnt/entJobOffer";
	}
	
	// 기업리뷰
	@GetMapping("/review")
	public String review(Model model) {
		
		// 현재 로그인한 회원 정보
		MemberVO memberVO = modelAttributeUtil.getCurrentLoginName();
		String memId = memberVO.getMemId();
		
		
		List<BoardEntReviewVO> brdEntReviewVOList = this.boardEntReviewService.brdEnterpriseVOList(memId);
		log.info("enterReview -> brdEntReviewVOList : " + brdEntReviewVOList); 

		EnterpriseVO enterpriseVO = this.enterpriseService.entReviewVO(memId);
		
		enterpriseVO.setBoardEntReviewVOList(brdEntReviewVOList);
		
		log.info("enterReview -> enterpriseVO : " + enterpriseVO); 
		
		model.addAttribute("memberVO",memberVO);
		model.addAttribute("enterpriseVO",enterpriseVO);
		model.addAttribute("brdEntReviewVOList",brdEntReviewVOList);
		
		return "mypageEnt/entReview";
	}
	
	// 기업 상품
	@GetMapping("/items")
	public String items() {
		
		return "mypageEnt/entItems";
	}
	

}

