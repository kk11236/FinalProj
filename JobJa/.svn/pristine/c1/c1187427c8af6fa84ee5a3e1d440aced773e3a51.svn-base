<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jobJa.member.mapper.PortfolioMapper">

	<sql id="where">
		<if test="keyword!=null and keyword!=''">
			AND  (PTFL_TITLE LIKE '%' || #{keyword} || '%')
	    </if>  
	</sql>

	<resultMap type="portfolioVO" id="portfolioMap">
		<id property= "ptflNo"  column= "PTFL_NO" />
		<id property= "memId"  column= "MEM_ID" />
		<result property= "ptflTitle"  column= "PTFL_TITLE" />
		<result property= "ptflWritingDt"  column= "PTFL_WRITING_DT" />
		<result property= "ptflUpdtDt"  column= "PTFL_UPDT_DT" />
		<result property= "gubun"  column= "GUBUN" />
		<result property="rnum" column="RNUM"/>
		<association property="portfolioBasicVO" resultMap="portBasicMap"></association>
		<collection property="portfolioFreeVOList" resultMap="portFreeMap"></collection>
	</resultMap>
	
	<resultMap type="portBasicVO" id="portBasicMap">
		<result property= "ptflNo"  column= "PTFL_NO" />
		<result property= "memId"  column= "MEM_ID" />
		<result property= "ptflGrowth"  column= "PTFL_GROWTH" />
		<result property= "ptflMotive"  column= "PTFL_MOTIVE" />
		<result property= "ptflPersonality"  column= "PTFL_PERSONALITY" />
		<result property= "ptflJobExp"  column= "PTFL_JOB_EXP" />
		<result property= "ptflProjExp"  column= "PTFL_PROJ_EXP" />
		<result property= "ptflAspirations"  column= "PTFL_ASPIRATIONS" />
	</resultMap>
	
	<resultMap type="portFreeVO" id="portFreeMap">
		<result property= "ptflNo"  column= "PTFL_NO" />
		<result property= "memId"  column= "MEM_ID" />
		<result property= "ptflFreeq"  column= "PTFL_FREEQ" />
		<result property= "ptflFreea"  column= "PTFL_FREEA" />
	</resultMap>

	<!-- 자기소개서 목록 -->
	<select id="list" parameterType="hashMap" resultMap="portfolioMap">
	/* portfolio list */
	
		SELECT T.*
				FROM
				(
					SELECT ROWNUM RNUM, U.*
					FROM
					(
					    SELECT  ROW_NUMBER() OVER(ORDER BY A.PTFL_NO DESC) RNUM1,
					        	A.PTFL_NO, A.MEM_ID, A.PTFL_TITLE, A.PTFL_WRITING_DT, 'BASIC' GUBUN
					    FROM 	PORTFOLIO A, PORTFOLIO_BASIC B
					    WHERE 	A.PTFL_NO = B.PTFL_NO
					    
					    UNION ALL
					    
					    SELECT 	ROW_NUMBER() OVER(ORDER BY A.PTFL_NO DESC) RNUM2,
					        	A.PTFL_NO, A.MEM_ID, A.PTFL_TITLE, A.PTFL_WRITING_DT, 'FREE' GUBUN
					    FROM 	PORTFOLIO A
					    <where>
					        <include refid="where"></include>
					    </where>
				    ) U
				) T
		WHERE T.MEM_ID = #{memId}		

	</select>
	
	<!-- 전체행의 수(검색 포함) -->
	<select id="getTotal" parameterType="hashMap" resultType="int">

		SELECT COUNT(*) FROM PORTFOLIO
		
	</select>
	
	<!-- 다음 기본키 값 가져오기 -->
	<select id="getPtflNo" resultType="String">

		 SELECT 'PTF' || TO_CHAR(COALESCE(MAX(TO_NUMBER(SUBSTR(PTFL_NO, 4))),0) + 1, 'FM00000')
		 FROM PORTFOLIO

	</select>
	
	<!-- 자기소개서 등록 -->
	
	<!-- portfolioVO 추가
	PortfolioVO(ptflNo=null, memId=a111, ptflTitle=자기소개서 제목, ptflWritingDt=null, ptflUpdtDt=null, rnum=null, uploadFile=null, portfolioBasicVO=null, portfolioFreeVOList=[
		PortfolioFreeVO(ptflNo=null, memId=null, ptflFreeq=질문1, ptflFreea=답변2), 
		PortfolioFreeVO(ptflNo=null, memId=null, ptflFreeq=질문2, ptflFreea=답변2)])
	 -->
	<insert id="createForm" parameterType="portfolioVO">
	/* PortfolioCreate */
		<!-- ptflNo : PTF00010 -->
		<selectKey resultType="String" order="BEFORE" keyProperty="ptflNo">
			SELECT 'PTF' || TO_CHAR(COALESCE(MAX(TO_NUMBER(SUBSTR(PTFL_NO, 4))),0) + 1, 'FM00000')
			FROM PORTFOLIO
		</selectKey>
		
	    INSERT INTO PORTFOLIO (
	    			PTFL_NO, MEM_ID, PTFL_TITLE,
	    			PTFL_WRITING_DT, PTFL_UPDT_DT)
	    VALUES 		(#{ptflNo}, #{memId}, #{ptflTitle}, SYSDATE, SYSDATE)
	    
	</insert>
	
	<!-- PortfolioBasicVO 추가 -->
	<insert id="portBasicCreate" parameterType="portfolioVO">
	/* PortBasicCreate */
	
	    INSERT INTO PORTFOLIO_BASIC (
		    		PTFL_NO, MEM_ID, PTFL_GROWTH, PTFL_MOTIVE,
		    		PTFL_PERSONALITY, PTFL_JOB_EXP, PTFL_PROJ_EXP, PTFL_ASPIRATIONS)
	    VALUES 		(#{ptflNo}, #{memId}, #{ptflGrowth}, #{ptflMotive}, #{ptflPersonality},
	    			#{ptflJobExp}, #{ptflProjExp}, #{ptflAspirations})
	    			
	</insert>
	
	<!-- PortfolioFreeVO 추가
	PortfolioFreeVO(ptflNo=PTF00010, memId=a111, ptflFreeq=질문1, ptflFreea=답변2),
	 -->
	<insert id="portFreeCreate" parameterType="portfolioVO">
	/* PortFreeCreate */
	
	    INSERT INTO PORTFOLIO_FREE (PTFL_NO, MEM_ID, PTFL_FREEQ, PTFL_FREEA)
	    VALUES (#{ptflNo}, #{memId}, #{ptflFreeq}, #{ptflFreea})
	    
	</insert>
	
	
	<!-- 자기소개서 상세보기 -->
	<select id="detail" parameterType="String" resultMap="portfolioMap">
		/* portfolio detail */
		
		SELECT  A.PTFL_NO, A.MEM_ID, A.PTFL_TITLE, A.PTFL_WRITING_DT, A.PTFL_UPDT_DT,
		        B.PTFL_GROWTH, B.PTFL_MOTIVE, B.PTFL_PERSONALITY,
		        B.PTFL_JOB_EXP, B.PTFL_PROJ_EXP, B.PTFL_ASPIRATIONS
		FROM    PORTFOLIO A, PORTFOLIO_BASIC B
		WHERE   A.PTFL_NO = B.PTFL_NO
		AND     A.PTFL_NO = #{ptflNo}	

	</select>
	
	<!-- 자기소개서 자유양식 상세보기 -->
	<select id="freeDetail" parameterType="String" resultMap="portfolioMap">
		/* portfolio freeDetail */
		
		SELECT  A.PTFL_NO, A.MEM_ID, A.PTFL_TITLE, A.PTFL_WRITING_DT, A.PTFL_UPDT_DT,
		        B.PTFL_FREEQ, B.PTFL_FREEA
		FROM    PORTFOLIO A, PORTFOLIO_FREE B
		WHERE   A.PTFL_NO = B.PTFL_NO
		AND     A.PTFL_NO = #{ptflNo}	

	</select>
	
	
	<!-- 자기소개서 공통 수정 -->
	<update id="update" parameterType="portfolioVO">
	/* portfolio updatePost */
	
	
		UPDATE 	PORTFOLIO
		SET		PTFL_TITLE	 = #{ptflTitle},
				PTFL_UPDT_DT = SYSDATE
		WHERE 	PTFL_NO 	 = #{ptflNo}	
	
	</update>
	
	<!-- 자기소개서 기본양식 수정 -->
	<update id="portBasicUpdate" parameterType="portfolioVO">
	/* PORTFOLIO_BASIC UPDATEPOST */
	
		UPDATE 	PORTFOLIO_BASIC
		SET		PTFL_GROWTH				= #{ptflGrowth},
				PTFL_MOTIVE				= #{ptflMotive},
				PTFL_PERSONALITY		= #{ptflPersonality},
				PTFL_JOB_EXP			= #{ptflJobExp},
				PTFL_PROJ_EXP			= #{ptflProjExp},
				PTFL_ASPIRATIONS		= #{ptflAspirations}
		WHERE 	PTFL_NO 				= #{ptflNo}	
	
	</update>

	<!-- 자기소개서 자유양식 수정 -->
	<update id="portFreeUpdate" parameterType="portFreeVO" >
	/* PORTFOLIO_FREE UPDATEPOST */

		UPDATE  PORTFOLIO_FREE
		
		SET		PTFL_FREEQ	 = #{ptflFreeq},
				PTFL_FREEA	 = #{ptflFreea}
		WHERE 	PTFL_NO 	 = #{ptflNo}	
	
	</update>
	
	<!-- 자기소개서 삭제 -->	
	<delete id="deletePost" parameterType="portfolioVO">
	
		DELETE FROM PORTFOLIO
		WHERE PTFL_NO = #{ptflNo}
		
	</delete>

</mapper>