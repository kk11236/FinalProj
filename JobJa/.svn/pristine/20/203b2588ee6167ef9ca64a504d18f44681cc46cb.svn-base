<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
<style type="text/css">
.container {
	width: 500px;
}

#list {
	height: 300px;
	padding: 15px;
	overflow: auto;
}
</style>
<script type="text/javascript" src="/resources/js/jquery-3.6.0.js"></script>
<title>학사관리시스템</title>
<script type="text/javascript">
//채팅 서버 주소
let url = "ws://localhost/chatserver";
   		
// 웹 소켓
let ws;

$(function(){
	// 연결하기
	$('#btnConnect').click(function() {
	
		// 유저명 확인
	   	if ($('#memId').val().trim() != '') {
	   		console.log("url : " + url);
	   		// 연결
		   	ws = new WebSocket(url);
		   			
		   	// 소켓 이벤트 매핑
		   	//1) 연결
		   	ws.onopen = function (evt) {
		   		// console.log('서버 연결 성공');
		   		print($('#memId').val(), '입장했습니다.');
		   		
				var msg = {
		   		    type: "enter",
		   		    memId:   $('#memId').val(),
				};
		   				
		   		// 현재 사용자가 입장했다고 서버에게 통지(유저명 전달)
		   		// -> 1#유저명
// 				ws.send('1#' + $('#memId').val() + '#');
		   		ws.send(JSON.stringify(msg));
						
				$('#memId').attr('readonly', true);
				$('#btnConnect').attr('disabled', true);
				$('#btnDisconnect').attr('disabled', false);
				//연결버튼 클릭하면 하단의 메시지 텍스트박스를 활성화
				$('#msg').attr('disabled', false);
				$('#msg').focus();
			};
	        
			//2) 메시지 전송
			ws.onmessage = function (evt) {
	
				console.log("evt : ", evt);
				console.log("evt.data : ", evt.data);
	
				let msg = JSON.parse(evt.data);
				console.log("msg : ", msg);
	
				if (msg.type == 'enter') {
					print2(msg.memId);
				} else if (msg.type == 'send') {
					print(msg.memId, msg.text);
				} else if (msg.type == 'close') {
					print3(msg.memId);
				}
				$('#list').scrollTop($('#list').prop('scrollHeight'));
			};
		   			
			ws.onclose = function (evt) {
				console.log('소켓이 닫힙니다.');
			};
	
			ws.onerror = function (evt) {
				console.log(evt.data);
			};
		} else {
			alert('유저명을 입력하세요.');
			$('#memId').focus();
		}
	});//end btnConnect
	
	$('#memId').keydown(function() {
		if (event.keyCode == 13) {
			$('#btnConnect').click();
		}
	});
			
			
	$('#msg').keydown(function() {
		if (event.keyCode == 13) {
					
			let msg = {
	   		    type: "send",
	   		 	text: $(this).val(),
	   		    memId:  document.getElementById("memId").value
			};
			
			//서버에게 메시지 전달
			ws.send(JSON.stringify(msg));
			print($('#memId').val(), $(this).val()); //본인 대화창에
			
	        $('#msg').val('');
			$('#msg').focus();
					
		}
	});
			
	$('#btnDisconnect').click(function() {
		
		let msg = {
   		    type: "close",
   		    memId:  document.getElementById("memId").value
		};
		
		ws.send(JSON.stringify(msg));
		ws.close();
				
		$('#memId').attr('readonly', false);
	    $('#memId').val('');
				
		$('#btnConnect').attr('disabled', false);
		$('#btnDisconnect').attr('disabled', true);
				
		$('#msg').val('');
		$('#msg').attr('disabled', true);
	});
});

// 메세지 전송 및 아이디
function print(memId, text) {
	let temp = '';
	temp += '<div style="margin-bottom:3px;">';
	temp += '[' + memId + '] ';
	temp += text;
	temp += ' <span style="font-size:11px;color:#777;">' + new Date().toLocaleTimeString() + '</span>';
	temp += '</div>';
			
	$('#list').append(temp);
}
		
// 다른 client 접속		
function print2(memId) {
	let temp = '';
	temp += '<div style="margin-bottom:3px;">';
	temp += "'" + memId + "' 이(가) 접속했습니다." ;
	temp += ' <span style="font-size:11px;color:#777;">' + new Date().toLocaleTimeString() + '</span>';
	temp += '</div>';
			
	$('#list').append(temp);
}

// client 접속 종료
function print3(memId) {
	let temp = '';
	temp += '<div style="margin-bottom:3px;">';
	temp += "'" + memId + "' 이(가) 종료했습니다." ;
	temp += ' <span style="font-size:11px;color:#777;">' + new Date().toLocaleTimeString() + '</span>';
	temp += '</div>';
			
	$('#list').append(temp);
}
</script>
</head>
<body>

<div class="container">
	<h1 class="page-header">Chat</h1>		
	
	<table class="table table-bordered">
		<tr>
			<td><input type="text" name="memId" id="memId" class="form-control" placeholder="유저명" value="${memId}"></td>
			<td>
				<button type="button" class="btn btn-default" id="btnConnect">연결</button>
				<button type="button" class="btn btn-default" id="btnDisconnect" disabled>종료</button>
			</td>
		</tr>
		<tr>
			<td colspan="2"><div id="list"></div></td>
		</tr>
		<tr>
			<td colspan="2"><input type="text" name="msg" id="msg" placeholder="대화 내용을 입력하세요." class="form-control" disabled></td>
		</tr>
	</table>
</div>

</body>
</html>